<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title> Flare </title>

    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: row;
            align-items: stretch;
        }

        #server-container {
            flex: 0 0 72px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px 0px;
        }

        #channels-container {
            flex: 0 0 240px;
            background-color: var(--vscode-sideBar-background);
            padding: 12px;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: space-between;
            flex: 8 0 auto;
            padding: 20px;
        }

        #content-container {
            overflow-y: scroll;
        }

        #input-field-container {
            width: 100%;
        }

        #message-input {
            width: 100%;
            height: 44px;
            background-color: var(--vscode-input-background);
            border-radius: 8px;
            border: 2px solid var(--vscode-button-secondaryBackground);
            outline: none;
            padding-left: 20px;
            color: var(--vscode-input-foreground);
            transition: 0.25s ease-out;
        }

        #message-input:hover {
            border-color: var(--vscode-button-secondaryHoverBackground);
        }

        #message-input:focus {
            border-color: var(--vscode-button-background);
            transition: 0.25s ease-out;
        }

        .message-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            /* padding-bottom: 10px; */
        }

        .message-avatar-container {
            height: 38px;
            width: 38px;
            position: relative;
        }

        .message-data-container {
            flex: 1 1;
            padding-left: 8px;
        }

        .message-info-row {
            line-height: 20px;
        }

        .message-avatar-img {
            width: 100%;
            height: 100%;
            display: inline-block;
            border-radius: 50%;
            position: absolute;
            top: 0;
        }

        .message-content-row {
            line-height: 20px;
        }

        .message-info-author {
            font-weight: 600;
            padding-right: 3px;
        }

        .message-info-timestamp {
            font-size: smaller;
            color: var(--vscode-titleBar-inactiveForeground);
        }

        #message-list-tail {
            height: 20px;
        }

        #channels-header {
            height: 25px;
        }

        .channel-container {
            border-radius: 3px;
            margin-bottom: 6px;
            padding: 5px 10px;
            color: var(--vscode-debugIcon-breakpointDisabledForeground);
        }

        .channel-container-active,
        .channel-container:hover {
            color: var(--vscode-editor-foreground);
            background-color: var(--vscode-editor-selectionBackground);
        }

        .guild-container {
            position: relative;
            height: 48px;
            width: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: var(--vscode-sideBar-dropBackground);
            overflow: hidden;
            transition: 0.25s ease-out;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        .guild-active,
        .guild-container:hover {
            border-radius: 30%;
        }

        .guild-name-text {
            position: absolute;
            font-size: 20px;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div id="server-container">

    </div>
    <div id="channels-container">
        <span id="channels-header">
            TEXT CHANNELS
        </span>
    </div>
    <div id="chat-container">
        <div id="content-container">
            <div id='message-list-tail'></div>
        </div>
        <div id="input-field-container">
            <input id="message-input" placeholder="Message Channel" onkeydown="sendMessageToDiscord(this)">
        </div>
    </div>


    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
    <script src='{{base_url}}/socket.io/socket.io.js'></script>
    <script>
        "use strict;"

        const contentContainer = document.getElementById('content-container')
        const messageListTail = document.getElementById('message-list-tail')

        const sessionID = '{{sessionID}}'
        const socket = io('{{base_url}}', { auth: { sessionID } })

        const LocalStorage = {}

        const previousAuthor = null
        /*
        {
            guildID: {
                name: string,
                icon: string | null,
                channels: {
                    name: string,
                    messages: [
                        {

                        }
                    ]
                }
            }
        }
        */

        const buildFromTemplate = (template, templateValues) => {
            for (let query in templateValues) {
                console.log(query)
            }
            const container = document.createElement('div')
            container.innerHTML = template;

            for (let query in templateValues) {
                const elem = container.querySelector(query)
                elem.innerText = templateValues[query]
            }

            return container
        }

        // {
        // 	messageID: msg.id,
        // 	author: {
        // 		id: msg.author.id,
        // 		name: msg.author.username,
        // 		pfp: msg.author.displayAvatarURL(),
        // 	},
        // 	guild: {
        // 		id: msg.guild.id,
        // 		name: msg.guild.name,
        // 		icon: msg.guild.iconURL(),
        // 	},
        // 	channelID: msg.channel.id,
        // 	timestamp: msg.createdAt.toISOString(),
        // 	editedTimestamp: msg.editedAt && msg.editedAt.toISOString(),
        // 	content: msg.content,
        // }
        const createMessage = (message, displayHeader) => {
            const template = `
                <div class='message-container'>
                    <div class='message-avatar-container'>
                        <img class='message-avatar-img'>
                    </div>
                    <div class='message-data-container'>
                        <div class='message-info-row'>
                            <span class='message-info-author'></span>
                            <span class='message-info-timestamp'></span>
                        </div>
                        <div class='message-content-row'>
                        </div>
                    </div>
                </div>
            `

            const elem = buildFromTemplate(template, {
                '.message-info-author': message.author.name,
                '.message-info-timestamp': dayjs(message.timestamp).format('MM/DD/YY [at] h:mm A'),
                '.message-content-row': message.content
            })


            if (displayHeader) {
                const avatar = elem.querySelector('.message-avatar-img')
                avatar.src = message.author.pfp
                elem.querySelector('.message-container').style.paddingTop = '15px'

            } else {
                elem.querySelector('.message-avatar-container').style.height = 'initial'
                elem.querySelector('.message-avatar-img').remove()
                elem.querySelector('.message-info-row').remove()
            }

            return elem
        }

        const handleMessage = (data) => {
            const message = createMessage(data, data.author.id !== previousAuthor)
            contentContainer.insertBefore(message, messageListTail)

            // Every time a new message gets sent, it scrolls the page to the bottom
            updateScroll()

            // Keep track of who the previous author was to ensure messages group correctly
            previousAuthor = data.author.id
        }

        // Keeps the page scrolled to the bottom
        const updateScroll = () => {
            var element = document.getElementById("content-container")
            element.scrollTop = element.scrollHeight;
        }

        const sendMessageToDiscord = textField => {
            if (event.key === 'Enter') {
                console.log(textField.value)
                // Send the value over socket with user and message. Parse which guild to send it to on backend
                socket.send('flare-message', textField.value)
                // clear the textField
                textField.value = ''
            }
        }

        const getInitials = name => name.split(/\W/).map(x => x ? x[0] : '').join('')

        const handleGuilds = guildsList => {
            const template = `
                <div class='guild-container'>
                    <img class='guild-icon-img'>
                    <span class='guild-name-text'>
                    </span>
                </div>
            `
            const container = document.getElementById("server-container")
            container.innerHTML = ''

            for (const guild of guildsList) {
                const elem = buildFromTemplate(template, {
                    '.guild-name-text': getInitials(guild.name)
                })

                if (!guild.icon) {
                    elem.querySelector('.guild-icon-img').remove()
                } else {
                    elem.querySelector('.guild-icon-img').src = guild.icon
                    elem.querySelector('.guild-name-text').remove()
                }

                container.appendChild(elem)

                const channelMap = {}
                for (const channel of guild.guildChannels) {
                    channelMap[channel.channelID] = []
                }


            }
        }

        const setChannels = guild => {
            const container = document.getElementById("channels-container")
            container.innerHTML = ''

            const headerTemplate = `
                <div id='channels-header'>
                    TEXT CHANNELS
                </div>
            `
            const header = buildFromTemplate(headerTemplate, {})
            container.appendChild(header)

            if (!guild) return

            const channelTemplate = `
                <div class='channel-container'>
                    <span class='channel-name-text'></span>
                </div>
            `

            for (const channel of guild.guildChannels) {
                const elem = buildFromTemplate(channelTemplate, {
                    '.channel-name-text': `# ${channel.channelName.toLowerCase()}`
                })

                const channelContainer = elem.querySelector('.channel-container')
                channelContainer.onclick = () => {
                    document.querySelectorAll('.channel-container-active').forEach(element => {
                        element.classList.remove('channel-container-active')
                    })

                    channelContainer.classList.add('channel-container-active')
                }

                container.appendChild(elem)
            }
        }

        socket.on('flare-message', handleMessage)
        socket.on('flare-user-guilds', data => {
            handleGuilds(data)
            setChannels(data.length > 0 ? data[0] : null)
        })

        socket.on('connect_error', err => {
            console.error(`connect_error: ${err.message}`)
        })

        socket.emit('flare-user-guilds', '')
    </script>
</body>

</html>