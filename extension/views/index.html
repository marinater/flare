<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title> Flare </title>

    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: row;
            align-items: stretch;
        }

        #server-container {
            flex: 0 0 72px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px 0px;
        }

        #channels-container {
            flex: 0 0 240px;
            background-color: var(--vscode-sideBar-background);
            padding: 12px;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            flex: 8 0 auto;
            padding: 20px;
        }

        #message-list {
            height: 100%;
            overflow-y: scroll;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: stretch;
        }

        #input-field-container {
            width: 100%;
            flex-grow: 0;
            flex-shrink: 0;
        }

        #message-input {
            width: 100%;
            height: 44px;
            background-color: var(--vscode-input-background);
            border-radius: 8px;
            border: 2px solid var(--vscode-button-secondaryBackground);
            outline: none;
            padding-left: 20px;
            color: var(--vscode-input-foreground);
            transition: 0.25s ease-out;
        }

        #message-input:hover {
            border-color: var(--vscode-button-secondaryHoverBackground);
        }

        #message-input:focus {
            border-color: var(--vscode-button-background);
            transition: 0.25s ease-out;
        }

        .message-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            /* padding-bottom: 10px; */
        }

        .message-avatar-container {
            height: 38px;
            width: 38px;
            position: relative;
        }

        .message-data-container {
            flex: 1 1;
            padding-left: 8px;
        }

        .message-info-row {
            line-height: 20px;
        }

        .message-avatar-img {
            width: 100%;
            height: 100%;
            display: inline-block;
            border-radius: 50%;
            position: absolute;
            top: 0;
        }

        .message-content-row {
            line-height: 20px;
        }

        .message-info-author {
            font-weight: 600;
            padding-right: 3px;
        }

        .message-info-timestamp {
            font-size: smaller;
            color: var(--vscode-titleBar-inactiveForeground);
        }

        #message-list-tail {
            height: 20px;
            flex-grow: 0;
            flex-shrink: 0;
        }

        #channels-header {
            height: 25px;
        }

        .channel-container {
            border-radius: 3px;
            margin-bottom: 6px;
            padding: 5px 10px;
            color: var(--vscode-debugIcon-breakpointDisabledForeground);
        }

        .channel-container-active,
        .channel-container:hover {
            color: var(--vscode-editor-foreground);
            background-color: var(--vscode-editor-selectionBackground);
        }

        .guild-container {
            position: relative;
            height: 48px;
            width: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: var(--vscode-sideBar-dropBackground);
            overflow: hidden;
            transition: 0.25s ease-out;
            margin-bottom: 8px;
        }

        .guild-active,
        .guild-container:hover {
            border-radius: 30%;
        }

        .guild-name-text {
            position: absolute;
            font-size: 20px;
            line-height: 20px;
            vertical-align: middle;
        }

        #message-scroll-wrapper {
            flex: 1 1;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="server-container">

    </div>
    <div id="channels-container">
        <span id="channels-header">
            TEXT CHANNELS
        </span>
    </div>
    <div id="chat-container">
        <div id="message-scroll-wrapper">
            <div id="message-list">
                <div id='message-list-tail'></div>
            </div>
        </div>
        <div id="input-field-container">
            <input id="message-input" placeholder="Run !link inside the server you want to receive updates for!">
        </div>
    </div>


    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
    <script src='{{base_url}}/socket.io/socket.io.js'></script>
    <script>
        "use strict;"

        const sessionID = '{{sessionID}}'
        const socket = io('{{base_url}}', { auth: { sessionID } })

        let currentChannel = null
        let currentGuild = null
        let localMessageStorage = {}

        /*
        {
            guildID: {
                id: string,
                name: string,
                icon: string | null,
                channels: {
                    channelID: {
                        id: string
                        name: string,
                        messages: [
                            { message object from backend }
                        ]
                    }
                }
            }
        }
        */

        const setActiveGuild = () => {
            document.querySelectorAll('.guild-active').forEach(
                elem => {
                    if (elem.id !== `guild-${currentGuild.id}`)
                        elem.classList.remove('guild-active')
                }
            )
            document.getElementById(`guild-${currentGuild.id}`).classList.add('guild-active')
        }

        const setActiveChannel = () => {
            document.querySelectorAll('.channel-container-active').forEach(
                elem => {
                    if (elem.id !== `channel-${currentChannel.id}`)
                        elem.classList.remove('channel-container-active')
                }
            )
            document.getElementById(`channel-${currentChannel.id}`).classList.add('channel-container-active')
        }

        const buildFromTemplate = (template, templateValues) => {
            const container = document.createElement('div')
            container.innerHTML = template;

            for (let query in templateValues) {
                const elem = container.querySelector(query)
                elem.innerText = templateValues[query]
            }

            return container
        }

        const createMessage = (message, displayHeader) => {
            const template = `
                <div class='message-container'>
                    <div class='message-avatar-container'>
                        <img class='message-avatar-img'>
                    </div>
                    <div class='message-data-container'>
                        <div class='message-info-row'>
                            <span class='message-info-author'></span>
                            <span class='message-info-timestamp'></span>
                        </div>
                        <div class='message-content-row'>
                        </div>
                    </div>
                </div>
            `

            const elem = buildFromTemplate(template, {
                '.message-info-author': message.author.name,
                '.message-info-timestamp': dayjs(message.timestamp).format('MM/DD/YY [at] h:mm A'),
                '.message-content-row': message.content
            })

            if (displayHeader) {
                const avatar = elem.querySelector('.message-avatar-img')
                avatar.src = message.author.pfp
                elem.querySelector('.message-container').style.paddingTop = '15px'

            } else {
                elem.querySelector('.message-avatar-container').style.height = 'initial'
                elem.querySelector('.message-avatar-img').remove()
                elem.querySelector('.message-info-row').remove()
            }

            const messageList = document.getElementById('message-list')
            const messageListTail = document.getElementById('message-list-tail')

            messageList.insertBefore(elem, messageListTail)
            messageList.scrollTop = messageList.scrollHeight
        }

        const setGuilds = () => {
            const container = document.getElementById("server-container")
            container.innerHTML = ''

            const template = `
                <div class='guild-container'>
                    <img class='guild-icon-img'>
                    <span class='guild-name-text'>
                    </span>
                </div>
            `

            for (const guild of Object.values(localMessageStorage)) {
                const elem = buildFromTemplate(template, {
                    '.guild-name-text': guild.name.split(" ").map(x => x ? x[0] : '').join('')
                })

                if (!guild.icon) {
                    elem.querySelector('.guild-icon-img').remove()
                } else {
                    elem.querySelector('.guild-icon-img').src = guild.icon
                    elem.querySelector('.guild-name-text').remove()
                }

                const elemInner = elem.querySelector('.guild-container')
                elemInner.id = `guild-${guild.id}`

                elemInner.onclick = () => {
                    currentGuild = guild
                    const channelList = Object.values(guild.channels)
                    currentChannel = channelList.length > 0 ? channelList[0] : null


                    setActiveGuild()
                    setChannels()
                    setChats()
                }
                container.appendChild(elem)
            }

            setActiveGuild()
        }

        const setChannels = () => {
            const container = document.getElementById("channels-container")
            container.innerHTML = ''

            const headerTemplate = `
                <div id='channels-header'>
                    TEXT CHANNELS
                </div>
            `
            const header = buildFromTemplate(headerTemplate, {})
            container.appendChild(header)

            if (!currentGuild) return

            const channelTemplate = `
                <div class='channel-container'>
                    <span class='channel-name-text'></span>
                </div>
            `

            for (const channel of Object.values(currentGuild.channels)) {
                const elem = buildFromTemplate(channelTemplate, {
                    '.channel-name-text': `# ${channel.name}`
                })

                const channelContainer = elem.querySelector('.channel-container')
                channelContainer.id = `channel-${channel.id}`

                channelContainer.onclick = () => {
                    currentChannel = channel

                    setActiveChannel()
                    document.getElementById('message-input').placeholder = `Message #${channel.name}`
                    setChats()
                }

                container.appendChild(elem)
            }

            setActiveChannel()
        }

        const setChats = () => {
            document.getElementById('message-list').innerHTML = '<div id="message-list-tail"></div>'

            if (!currentChannel) return

            let prevAuthor = null
            for (const message of currentChannel.messages) {
                createMessage(message, message.author.id !== prevAuthor)
                prevAuthor = message.author.id
            }
        }

        const inputField = document.getElementById('message-input')

        inputField.onkeydown = (event) => {
            if (event.keyCode !== 13) return
            if (!currentChannel && !currentGuild) {
                alert('Please select a server and channel!')
                return
            }

            document.getElementById('message-input')
            const retMessage = {
                channelID: currentChannel.id,
                guildID: currentGuild.id,
                content: inputField.value
            }

            socket.emit('flare-message', retMessage)
            inputField.value = ''
        }

        const handleMessage = (data) => {
            const guild = localMessageStorage[data.guildID]
            if (!guild) return

            const channel = guild.channels[data.channelID]
            if (!channel) return

            const messages = channel.messages
            prevAuthor = messages.length > 0 ? messages[messages.length - 1].author.id : null
            messages.push(data)

            if (currentChannel && data.channelID === currentChannel.id) {
                createMessage(data, data.author.id !== prevAuthor)
            }
        }

        socket.on('flare-message', handleMessage)
        socket.on('flare-user-guilds', data => {
            localMessageStorage = {}

            for (const guild of data) {
                localMessageStorage[guild.id] = {
                    id: guild.id,
                    name: guild.name,
                    icon: guild.icon,
                    channels: {}
                }

                for (const channel of guild.channels) {
                    localMessageStorage[guild.id].channels[channel.id] = {
                        id: channel.id,
                        name: channel.name,
                        messages: []
                    }
                }
            }

            const guildsList = Object.values(localMessageStorage)
            currentGuild = guildsList.length > 0 ? guildsList[0] : null

            if (currentGuild) {
                const channelsList = Object.values(currentGuild.channels)
                currentChannel = channelsList.length > 0 ? channelsList[0] : null
            }

            setGuilds()
            setChannels()
            setChats()
        })

        socket.on('connect_error', err => {
            console.error(`connect_error: ${err.message}`)
        })

        socket.emit('flare-user-guilds', '')
    </script>
</body>

</html>